########################################################################
#
# Description : 60-persistent-disk.rules
#
# Authors     : Based on Open Suse Udev Rules
#               kay.sievers@suse.de and hare@suse.de
#
# Adapted to  : Jim Gifford
# LFS
#
# Version     : 00.01
#
# Notes       :
#
########################################################################

# persistent disk links: /dev/disk/{by-id,by-uuid,by-label,by-path}
# scheme based on "Linux persistent device names", 2004, Hannes Reinecke <hare@suse.de>

ACTION!="add",		GOTO="persistent_end"
SUBSYSTEM!="block",	GOTO="persistent_end"

# skip rules for inappropriate block devices
KERNEL=="ram*|loop*|fd*|nbd*",	GOTO="persistent_end"

# never access removable ide devices, the drivers are causing event loops on open()
BUS=="ide",     DRIVER=="ide-cdrom", SYSFS{removable}=="1", GROUP="cdrom", MODE="660"
BUS=="ide",	DRIVER!="ide-cdrom", SYSFS{removable}=="1", GOTO="persistent_end"

# by-id (hardware serial number)
KERNEL=="hd*[!0-9]",	IMPORT{program}="ata_id --export $tempnode"
KERNEL=="hd*[!0-9]",	ENV{ID_SERIAL}=="?*", SYMLINK+="disk/by-id/ata-$env{ID_MODEL}_$env{ID_SERIAL}"
KERNEL=="hd*[0-9]",	IMPORT{parent}=="ID_*", SYMLINK+="disk/by-id/ata-$env{ID_MODEL}_$env{ID_SERIAL}-part%n"

KERNEL=="sd*[!0-9]|sr*",		SYSFS{ieee1394_id}=="*", ENV{ID_SERIAL}="$sysfs{ieee1394_id}", ENV{ID_BUS}="ieee1394"
KERNEL=="sd*[!0-9]|sr*",		ENV{ID_SERIAL}=="", IMPORT{program}="usb_id -x"
KERNEL=="sd*[!0-9]|sr*",		ENV{ID_SERIAL}=="", IMPORT{program}="scsi_id -g -x -s %p -d $tempnode"
KERNEL=="sd*[!0-9]|sr*",		ENV{ID_SERIAL}=="", IMPORT{program}="scsi_id -g -x -a -s %p -d $tempnode"
KERNEL=="dasd*[!0-9]",			IMPORT{program}="dasd_id --export $tempnode"
KERNEL=="sd*[!0-9]|sr*|dasd*[!0-9]",	ENV{ID_SERIAL}=="?*", SYMLINK+="disk/by-id/$env{ID_BUS}-$env{ID_SERIAL}"

# for partitions import parent information
KERNEL=="sd*[0-9]|dasd*[0-9]",	IMPORT{parent}=="ID_*"
KERNEL=="sd*[0-9]|dasd*[0-9]",	ENV{ID_SERIAL}=="?*", SYMLINK+="disk/by-id/$env{ID_BUS}-$env{ID_SERIAL}-part%n"

# by-path (shortest physical path)
KERNEL=="*[!0-9]|sr*",	ENV{ID_TYPE}=="?*", IMPORT{program}="path_id %p", SYMLINK+="disk/by-path/$env{ID_PATH}"
KERNEL=="sr*",		GOTO="persistent_end"
KERNEL=="*[0-9]",	IMPORT{parent}=="ID_*"
KERNEL=="*[0-9]",	ENV{ID_PATH}=="?*", SYMLINK+="disk/by-path/$env{ID_PATH}-part%n"

# by-label/by-uuid (filesystem properties)
KERNEL=="*[!0-9]",		SYSFS{removable}=="1", GOTO="persistent_end"
IMPORT{program}="vol_id --export $tempnode"
ENV{ID_FS_UUID}=="?*",		SYMLINK+="disk/by-uuid/$env{ID_FS_UUID}"
ENV{ID_FS_LABEL_SAFE}=="?*",	SYMLINK+="disk/by-label/$env{ID_FS_LABEL_SAFE}"

# BIOS Enhanced Disk Device
KERNEL=="*[!0-9]",	IMPORT{program}="edd_id --export $tempnode"
KERNEL=="*[!0-9]",	ENV{ID_EDD}=="?*", SYMLINK+="disk/by-id/edd-$env{ID_EDD}"
KERNEL=="*[0-9]",	ENV{ID_EDD}=="?*", SYMLINK+="disk/by-id/edd-$env{ID_EDD}-part%n"

KERNEL=="dm-[0-9]*",	ACTION=="add", PROGRAM="/sbin/dmsetup info -c --noopencount --noheadings -o name -j %M -m %m", SYMLINK+="disk/by-name/%c"

LABEL="persistent_end"
